TGT = @PACKAGE@

LINKSHARED = -lpthread -shared
BUILDSHARED = -fPIC
INCLUDE = -I.
INSTALLTO = @prefix@

CXX = @CXX@
CXXFLAGS = @CXXFLAGS@ $(INCLUDE)

DYNTGT = lib$(TGT).so
STATGT = lib$(TGT).a

.PHONY: all install clean depend static dynamic test check doc

all: $(DYNTGT) test

dynamic: $(DYNTGT)
static: $(STATGT)

$(DYNTGT): $(TGT).o
	$(CXX) $(CXXFLAGS) $(LINKSHARED) $< -o $@

$(STATGT): $(TGT).o
	$(AR) cru $@ $<

%.o: %.cpp
	$(CXX) $(CXXFLAGS) $(BUILDSHARED) -c -o $@ $<

test: $(DYNTGT)
	$(MAKE) -C test/

check: all test
	$(MAKE) -C test/ check

clean:
	rm -rf $(TGT).o $(DYNTGT) $(STATGT) *.ii *.s
	$(MAKE) -C test/ clean

install: all
	test -d $(INSTALLTO)/lib || mkdir $(INSTALLTO)/lib
	cp $(DYNTGT) $(INSTALLTO)/lib
	chmod +rx $(INSTALLTO)/lib/$(DYNTGT)

	# only install static lib if it exists
	! test -f $(STATGT) || cp $(STATGT) $(INSTALLTO)/lib
	! test -f $(STATGT) || chmod +rx $(INSTALLTO)/lib/$(STATGT)

	test -d $(INSTALLTO)/include || mkdir $(INSTALLTO)/include
	cp $(TGT).hpp $(INSTALLTO)/include
	chmod +r $(INSTALLTO)/include/$(TGT).hpp


depend:
	g++ -E -MM $(INCLUDE) $(TGT).cpp > DEPENDS

doc:
	doxygen
	$(MAKE) -C docs/latex/

include DEPENDS
